<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Health Tracker</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 42 42'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='42' y2='42' gradientUnits='userSpaceOnUse'%3E%3Cstop stop-color='%234ade80'/%3E%3Cstop offset='1' stop-color='%2360a5fa'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='42' height='42' rx='11' fill='url(%23g)'/%3E%3Cpolyline points='7,23 13,23 16,15 20,30 24,11 28,27 31,19 35,23' fill='none' stroke='white' stroke-width='2.8' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <style>
        :root {
            --bg: #0a0e14;
            --bg-secondary: #0f1419;
            --card: #151c28;
            --card-hover: #1a2332;
            --card-border: #232f3e;
            --primary: #4ade80;
            --primary-dim: #22543d;
            --accent: #60a5fa;
            --accent-dim: #1e3a5f;
            --purple: #a78bfa;
            --purple-dim: #3b2d5e;
            --orange: #fb923c;
            --orange-dim: #4a2c17;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --muted: #64748b;
            --border: #1e293b;
            --success: #4ade80;
            --warning: #fbbf24;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Layout */
        .app {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0;
        }
        .daily-quote {
            text-align: center;
            padding: 14px 20px;
            margin-bottom: 25px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
            border-bottom: 1px solid var(--border);
            letter-spacing: 0.02em;
            line-height: 1.6;
        }
        .daily-quote .quote-author {
            display: block;
            margin-top: 4px;
            font-style: normal;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--primary);
        }

        /* Quote Modal */
        .quote-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            justify-content: center;
            align-items: center;
            padding: 30px;
            animation: quoteOverlayIn 0.4s ease;
        }
        .quote-modal-overlay.visible {
            display: flex;
        }
        .quote-modal {
            max-width: 520px;
            width: 100%;
            text-align: center;
            animation: quoteModalIn 0.6s ease;
        }
        .quote-modal-icon {
            font-size: 3rem;
            margin-bottom: 24px;
            opacity: 0.7;
            color: var(--primary);
        }
        .quote-modal-text {
            font-size: 1.4rem;
            font-style: italic;
            color: var(--text);
            line-height: 1.7;
            letter-spacing: 0.01em;
            margin-bottom: 20px;
        }
        .quote-modal-author {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 40px;
        }
        .quote-modal-btn {
            background: var(--primary);
            color: var(--bg);
            border: none;
            padding: 14px 40px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s, opacity 0.15s;
        }
        .quote-modal-btn:hover {
            transform: scale(1.04);
        }
        .quote-modal-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }
        @keyframes quoteOverlayIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes quoteModalIn {
            from { opacity: 0; transform: translateY(20px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .header-left {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .header-logo {
            width: 42px;
            height: 42px;
            flex-shrink: 0;
        }
        .header-titles { flex: 1; }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2px;
        }
        .header .date {
            color: var(--muted);
            font-size: 0.85rem;
        }
        .header-actions {
            display: flex;
            gap: 8px;
        }
        .btn-header {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-header svg {
            width: 16px;
            height: 16px;
        }
        .btn-export {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: white;
        }
        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
        }
        .btn-import {
            background: var(--card);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
        }
        .btn-import:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        #import-file { display: none; }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 12px;
        }
        .tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text-secondary); }
        .tab.active {
            background: var(--card);
            color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--card-border);
            margin-bottom: 16px;
            overflow: hidden;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .card-body { padding: 16px 20px; }

        /* Progress & Streak Container */
        .progress-streak-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Streak Card */
        .streak-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
        }
        .streak-content {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .streak-icon {
            font-size: 2.5rem;
            line-height: 1;
        }
        .streak-info {
            flex: 1;
        }
        .streak-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 4px;
        }
        .streak-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--muted);
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            transition: all 0.2s;
        }
        .info-icon:hover {
            background: var(--card);
            color: var(--text);
        }

        /* Progress Bar */
        .progress-wrap {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 0 20px 16px;
        }
        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            min-width: 45px;
            text-align: right;
        }

        /* Supplement Items */
        .supp-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .supp-item:last-child { border-bottom: none; }
        .supp-item:hover { background: var(--card-hover); }
        .supp-item.checked { opacity: 0.5; }
        .supp-item.checked .supp-name { text-decoration: line-through; }
        .supp-item.disabled { opacity: 0.35; pointer-events: none; }
        .supp-item.optional { opacity: 0.7; }
        .supp-item.optional .tag { background: var(--border); color: var(--muted); }

        .supp-check {
            width: 22px;
            height: 22px;
            margin-right: 16px;
            cursor: pointer;
            accent-color: var(--primary);
            flex-shrink: 0;
        }
        .supp-info { flex: 1; }
        .supp-name { font-weight: 500; font-size: 0.95rem; }
        .supp-dose { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }

        .tag {
            display: inline-block;
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--card-border);
            color: var(--text-secondary);
            margin-left: 8px;
            text-transform: uppercase;
            font-weight: 500;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge.on { background: var(--primary-dim); color: var(--primary); }
        .badge.off { background: var(--orange-dim); color: var(--orange); }
        .badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Cycle Panel */
        .cycle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .cycle-row:last-child { border-bottom: none; }
        .cycle-name { font-weight: 500; }
        .cycle-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cycle-days { font-size: 0.8rem; color: var(--muted); }
        .btn-small {
            padding: 5px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-small:hover { background: var(--card-border); color: var(--text); }

        /* Weight Tracking */
        .weight-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: end;
        }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .input-group input {
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .input-group input::placeholder { color: var(--muted); }

        .btn-primary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: #0a0e14;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Weight History */
        .weight-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .history-title {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        .history-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .history-day {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px 8px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        .history-day.today {
            background: var(--primary-dim);
            border: 1px solid var(--primary);
        }
        .history-day:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
        }
        .history-day.editing {
            border: 1px solid var(--accent);
            background: var(--accent-dim);
        }
        .history-day .day-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .history-day .day-weight {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
        }
        .history-day .day-bf {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .history-day.empty .day-weight { color: var(--muted); }

        /* Edit Panel */
        .edit-panel {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--accent);
        }
        .edit-panel.active { display: block; }
        .edit-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .edit-panel-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent);
        }
        .edit-panel-close {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            line-height: 1;
        }
        .edit-panel-close:hover { color: var(--text); }
        .edit-panel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        .edit-panel-actions {
            display: flex;
            gap: 8px;
        }
        .btn-save {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: var(--accent);
            color: #0a0e14;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .btn-save:hover { opacity: 0.9; }
        .btn-delete {
            padding: 10px 16px;
            border: 1px solid #ef4444;
            border-radius: 6px;
            background: transparent;
            color: #ef4444;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-delete:hover {
            background: #ef4444;
            color: white;
        }

        /* Validation */
        .input-group input.error {
            border-color: #ef4444;
        }
        .input-group .error-msg {
            font-size: 0.7rem;
            color: #ef4444;
            margin-top: 4px;
            display: none;
        }
        .input-group .error-msg.show { display: block; }

        /* Workout Section */
        .workout-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .workout-btn {
            padding: 20px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .workout-btn:hover {
            border-color: var(--primary);
            background: var(--primary-dim);
        }
        .workout-btn.active {
            border-color: var(--primary);
            background: var(--primary-dim);
            color: var(--primary);
        }
        .workout-btn.push.active { border-color: var(--accent); background: var(--accent-dim); color: var(--accent); }
        .workout-btn.pull.active { border-color: var(--purple); background: var(--purple-dim); color: var(--purple); }
        .workout-btn.legs.active { border-color: var(--orange); background: var(--orange-dim); color: var(--orange); }
        .workout-btn.rest.active { border-color: var(--muted); background: var(--border); color: var(--text-secondary); }
        .workout-btn.zone2.active { border-color: #14b8a6; background: #0d3d38; color: #14b8a6; }
        .workout-btn.hiit.active { border-color: #f43f5e; background: #4a1521; color: #f43f5e; }

        .workout-section-label {
            font-size: 0.7rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            margin-top: 15px;
        }
        .workout-section-label:first-child { margin-top: 0; }

        /* Steps Input */
        .steps-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: border-color 0.2s;
        }
        .steps-inline:focus-within {
            border-color: var(--primary);
        }
        .steps-inline .steps-icon {
            font-size: 1.2rem;
        }
        .steps-inline input {
            width: 80px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
        }
        .steps-inline input:focus {
            outline: none;
        }
        .steps-inline input::placeholder {
            color: var(--muted);
            font-weight: 400;
        }
        .steps-inline .steps-label {
            font-size: 0.8rem;
            color: var(--muted);
        }
        .cardio-row {
            display: flex;
            gap: 10px;
        }
        .cardio-row .workout-selector {
            flex: 1;
            grid-template-columns: repeat(2, 1fr);
        }

        .workout-btn .workout-icon {
            font-size: 1.5rem;
            margin-bottom: 6px;
        }

        /* Exercise Panels */
        .exercise-panel {
            margin-top: 12px;
            padding: 0;
            background: transparent;
            border: none;
        }
        .exercise-panel-header {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-left: 4px;
        }
        .exercise-panel.push .exercise-panel-header { color: var(--accent); }
        .exercise-panel.pull .exercise-panel-header { color: var(--purple); }
        .exercise-panel.legs .exercise-panel-header { color: var(--orange); }

        /* Card-style exercise entries */
        .exercise-entry {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--border);
        }
        .exercise-panel.push .exercise-entry { border-left-color: var(--accent); }
        .exercise-panel.pull .exercise-entry { border-left-color: var(--purple); }
        .exercise-panel.legs .exercise-entry { border-left-color: var(--orange); }

        .exercise-entry-top {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .exercise-entry-top input[type="text"] {
            flex: 1;
            padding: 7px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text);
            font-size: 0.85rem;
        }
        .exercise-entry-top input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .exercise-history {
            font-size: 0.7rem;
            color: var(--muted);
            padding: 0 2px 6px;
            line-height: 1.4;
            display: none;
        }
        .exercise-history.visible {
            display: block;
        }
        .exercise-history .hist-date {
            color: var(--text-secondary);
        }
        .exercise-history .hist-label {
            color: var(--muted);
            margin-right: 2px;
        }

        .exercise-entry-nums {
            display: flex;
            gap: 8px;
        }
        .exercise-entry-nums input[type="number"] {
            flex: 1;
            padding: 7px 4px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text);
            font-size: 0.85rem;
            text-align: center;
            -moz-appearance: textfield;
        }
        .exercise-entry-nums input[type="number"]::-webkit-inner-spin-button,
        .exercise-entry-nums input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .exercise-entry-nums input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .exercise-remove {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--muted);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .exercise-remove:hover {
            background: #4a1521;
            color: #f43f5e;
        }
        .exercise-add-btn {
            width: 100%;
            padding: 10px;
            border: 1px dashed var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 4px;
        }
        .exercise-add-btn:hover {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }
        /* Workout Week View */
        .workout-week {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .week-day {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-day.today {
            border: 1px solid var(--primary);
        }
        .week-day .wd-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .week-day .wd-types {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .week-day .wd-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 3px 2px;
            border-radius: 3px;
        }
        .week-day .wd-type.push { background: var(--accent-dim); color: var(--accent); }
        .week-day .wd-type.pull { background: var(--purple-dim); color: var(--purple); }
        .week-day .wd-type.legs { background: var(--orange-dim); color: var(--orange); }
        .week-day .wd-type.rest { background: var(--border); color: var(--muted); }
        .week-day .wd-type.zone2 { background: #0d3d38; color: #14b8a6; }
        .week-day .wd-type.hiit { background: #4a1521; color: #f43f5e; }
        .week-day .wd-type.empty { color: var(--muted); }
        .week-day .wd-steps {
            font-size: 0.65rem;
            color: var(--muted);
            margin-top: 4px;
        }
        .week-day .wd-steps.good { color: var(--primary); }
        .week-day:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
        }
        .week-day.editing {
            border: 1px solid var(--accent);
            background: var(--accent-dim);
        }

        /* Chart */
        .chart-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chart-header .history-title { margin-bottom: 0; }
        .chart-range {
            display: flex;
            gap: 4px;
        }
        .chart-range button {
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: transparent;
            color: var(--muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chart-range button:hover { color: var(--text); }
        .chart-range button.active {
            background: var(--primary-dim);
            border-color: var(--primary);
            color: var(--primary);
        }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .charts-container.stacked {
            grid-template-columns: 1fr;
        }
        .chart-section {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
        }
        .chart-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        .chart-stat-inline {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 12px;
        }
        .chart-stat-label {
            font-size: 0.7rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
        }
        .chart-stat-value.weight { color: var(--accent); }
        .chart-stat-value.bf { color: var(--purple); }
        .chart-wrap {
            position: relative;
            height: 160px;
        }
        .chart-wrap canvas {
            width: 100%;
            height: 100%;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--muted);
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .legend-dot.weight { background: var(--accent); }
        .legend-dot.bf { background: var(--purple); }
        .no-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--muted);
            font-size: 0.9rem;
        }

        /* Reset Button */
        .btn-reset {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        .btn-reset:hover {
            background: var(--card);
            border-color: var(--card-border);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #22c55e;
            color: #fff;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            white-space: nowrap;
        }
        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.error {
            background: #ef4444;
        }

        /* Paste Modal */
        .paste-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            justify-content: center;
            align-items: center;
            padding: 30px;
            animation: quoteOverlayIn 0.4s ease;
        }
        .paste-modal-overlay.visible {
            display: flex;
        }
        .paste-modal {
            max-width: 480px;
            width: 100%;
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 28px;
            animation: quoteModalIn 0.6s ease;
        }
        .paste-modal h2 {
            font-size: 1.2rem;
            color: var(--text);
            margin-bottom: 8px;
        }
        .paste-modal p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }
        .paste-modal textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-family: monospace;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 16px;
            box-sizing: border-box;
        }
        .paste-modal textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .paste-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-paste-cancel {
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-paste-cancel:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        .btn-paste-load {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-paste-load:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
        }

        /* Supplement Management Modal */
        .supp-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            justify-content: center;
            align-items: flex-start;
            padding: 30px;
            overflow-y: auto;
            animation: quoteOverlayIn 0.4s ease;
        }
        .supp-modal-overlay.visible { display: flex; }
        .supp-modal {
            max-width: 540px;
            width: 100%;
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 28px;
            margin: auto;
            animation: quoteModalIn 0.6s ease;
        }
        .supp-modal h2 {
            font-size: 1.2rem;
            color: var(--text);
            margin-bottom: 16px;
        }
        .supp-modal-group {
            margin-bottom: 20px;
        }
        .supp-modal-group h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }
        .supp-modal-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            gap: 8px;
        }
        .supp-modal-row:last-child { border-bottom: none; }
        .supp-modal-row-info { flex: 1; min-width: 0; }
        .supp-modal-row-name { font-weight: 500; font-size: 0.9rem; }
        .supp-modal-row-dose { font-size: 0.75rem; color: var(--muted); }
        .supp-modal-row-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .btn-edit-supp, .btn-del-supp {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            transition: all 0.2s;
        }
        .btn-edit-supp:hover { background: var(--card-border); color: var(--text); }
        .btn-del-supp:hover { background: rgba(239, 68, 68, 0.15); color: #ef4444; border-color: #ef4444; }
        .supp-modal-edit-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .supp-modal-edit-row input,
        .supp-modal-edit-row select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.8rem;
        }
        .supp-modal-edit-row input:focus,
        .supp-modal-edit-row select:focus { outline: none; border-color: var(--accent); }
        .supp-modal-edit-actions {
            grid-column: span 2;
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        .supp-modal-add {
            border-top: 1px solid var(--card-border);
            padding-top: 16px;
            margin-top: 8px;
        }
        .supp-modal-add h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 10px;
            letter-spacing: 0.05em;
        }
        .supp-add-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        .supp-add-grid input,
        .supp-add-grid select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.8rem;
        }
        .supp-add-grid input:focus,
        .supp-add-grid select:focus { outline: none; border-color: var(--accent); }
        .supp-add-grid label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .supp-add-grid label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }
        .supp-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--card-border);
        }
        .btn-reset-defs {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-reset-defs:hover { background: var(--card-border); color: var(--text); }
        .btn-close-modal {
            padding: 8px 18px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-close-modal:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3); }
        .btn-edit-list {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px dashed var(--accent);
            border-radius: 12px;
            background: transparent;
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-edit-list:hover { background: rgba(96, 165, 250, 0.08); }

        /* Copy/Paste header buttons */
        .btn-copy {
            background: var(--card);
            border: 1px solid #22c55e;
            color: #22c55e;
        }
        .btn-copy:hover {
            background: rgba(34, 197, 94, 0.1);
            transform: translateY(-1px);
        }
        .btn-paste {
            background: var(--card);
            border: 1px solid var(--accent);
            color: var(--accent);
        }
        .btn-paste:hover {
            background: rgba(96, 165, 250, 0.1);
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .weight-input-grid { grid-template-columns: 1fr 1fr; }
            .weight-input-grid .btn-primary { grid-column: span 2; }
            .workout-selector { grid-template-columns: repeat(2, 1fr); }
            .history-grid, .week-grid { grid-template-columns: repeat(7, 1fr); gap: 4px; }
            .history-day, .week-day { padding: 8px 4px; }
            .history-day .day-weight { font-size: 0.75rem; }
            .charts-container { grid-template-columns: 1fr; }
            .progress-streak-container { grid-template-columns: 1fr; }
            .exercise-entry { padding: 8px 10px; }
            .exercise-entry-top input[type="text"] { font-size: 0.8rem; padding: 6px 8px; }
            .exercise-entry-nums input[type="number"] { font-size: 0.8rem; padding: 6px 4px; }
            .exercise-entry-nums { gap: 6px; }
            .header-actions { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<div class="quote-modal-overlay" id="quote-modal">
    <div class="quote-modal">
        <div class="quote-modal-icon">&ldquo;</div>
        <div class="quote-modal-text" id="quote-modal-text"></div>
        <div class="quote-modal-author" id="quote-modal-author"></div>
        <button class="quote-modal-btn" id="quote-modal-btn">Let's Go</button>
    </div>
</div>

<div class="paste-modal-overlay" id="paste-modal" onclick="handlePasteOverlayClick(event)">
    <div class="paste-modal">
        <h2>Paste Sync Data</h2>
        <p>Paste the sync string you copied from your other device. It starts with <code>HT:</code></p>
        <textarea id="paste-input" placeholder="Paste HT:... string here" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
        <div class="paste-modal-actions">
            <button class="btn-paste-cancel" onclick="closePasteModal()">Cancel</button>
            <button class="btn-paste-load" onclick="loadPastedData()">Load Data</button>
        </div>
    </div>
</div>

<div class="supp-modal-overlay" id="supp-modal" onclick="if(event.target===event.currentTarget)closeSuppModal()">
    <div class="supp-modal">
        <h2>Edit Supplement List</h2>
        <div id="supp-modal-list"></div>
        <div class="supp-modal-add">
            <h3>Add Supplement</h3>
            <div class="supp-add-grid">
                <input type="text" id="add-supp-name" placeholder="Name">
                <input type="text" id="add-supp-dose" placeholder="Dose">
                <select id="add-supp-slot">
                    <option value="morning">Morning</option>
                    <option value="afternoon">Afternoon</option>
                    <option value="evening">Evening</option>
                </select>
                <label><input type="checkbox" id="add-supp-optional"> Optional</label>
            </div>
            <button class="btn-close-modal" style="width:100%" onclick="addSupplement()">Add</button>
        </div>
        <div class="supp-modal-footer">
            <button class="btn-reset-defs" onclick="resetSupplementDefs()">Reset to Defaults</button>
            <button class="btn-close-modal" onclick="closeSuppModal()">Done</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<div class="app" id="app">
    <header class="header">
        <div class="header-left">
            <svg class="header-logo" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGrad" x1="0" y1="0" x2="42" y2="42" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#4ade80"/>
                        <stop offset="1" stop-color="#60a5fa"/>
                    </linearGradient>
                </defs>
                <rect width="42" height="42" rx="11" fill="url(#logoGrad)"/>
                <polyline points="7,23 13,23 16,15 20,30 24,11 28,27 31,19 35,23" stroke="white" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="header-titles">
                <h1>Daily Health Tracker</h1>
                <div class="date" id="current-date"></div>
            </div>
        </div>
        <div class="header-actions">
            <input type="file" id="import-file" accept=".json" onchange="importData(event)">
            <button class="btn-header btn-import" onclick="document.getElementById('import-file').click()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Import
            </button>
            <button class="btn-header btn-export" onclick="exportData()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Export
            </button>
            <button class="btn-header btn-copy" onclick="copyData()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
                Copy
            </button>
            <button class="btn-header btn-paste" onclick="openPasteModal()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Paste
            </button>
        </div>
    </header>

    <div class="daily-quote" id="daily-quote"></div>

    <nav class="tabs">
        <button class="tab active" data-tab="weight">Weight</button>
        <button class="tab" data-tab="workout">Workout</button>
        <button class="tab" data-tab="supplements">Supplements</button>
    </nav>

    <!-- Supplements Tab -->
    <div class="tab-content" id="tab-supplements">
        <div class="progress-streak-container">
            <div class="card">
                <div class="card-header">
                    <h2>Today's Progress</h2>
                    <span class="progress-text" id="progress-percent">0%</span>
                </div>
                <div class="progress-wrap">
                    <div class="progress-bar"><div class="fill" id="progress-fill"></div></div>
                </div>
            </div>

            <div class="card streak-card">
                <div class="streak-content">
                    <div class="streak-icon">ðŸ”¥</div>
                    <div class="streak-info">
                        <div class="streak-value" id="stat-streak">0</div>
                        <div class="streak-label">
                            Supplement Streak
                            <span class="info-icon" title="Complete all required supplements every day to build your streak. Skipping a day resets it to 0.">â“˜</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="cycle-status-card"></div>

        <button class="btn-edit-list" onclick="openSuppModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            Edit Supplement List
        </button>

        <div id="supp-list-morning"></div>
        <div id="supp-list-afternoon"></div>
        <div id="supp-list-evening"></div>

        <button class="btn-reset" onclick="resetSupplements()">Reset for Tomorrow</button>
    </div>

    <!-- Weight Tab -->
    <div class="tab-content active" id="tab-weight">
        <div class="card">
            <div class="card-header"><h2>Morning Weigh-In</h2></div>
            <div class="card-body">
                <div class="weight-input-grid">
                    <div class="input-group">
                        <label>Weight (kg)</label>
                        <input type="number" id="weight-input" placeholder="71.0" step="0.1" min="20" max="300" oninput="validateWeightInputs()">
                        <div class="error-msg" id="weight-error">Must be 20-300 kg</div>
                    </div>
                    <div class="input-group">
                        <label>Body Fat %</label>
                        <input type="number" id="bf-input" placeholder="15.0" step="0.1" min="1" max="60" oninput="validateWeightInputs()">
                        <div class="error-msg" id="bf-error">Must be 1-60%</div>
                    </div>
                    <button class="btn-primary" id="log-weight-btn" onclick="logWeight()" disabled>Log</button>
                </div>
                <div class="weight-history">
                    <div class="history-title">Last 7 Days (click to edit)</div>
                    <div class="history-grid" id="weight-history"></div>
                    <div class="edit-panel" id="edit-panel">
                        <div class="edit-panel-header">
                            <span class="edit-panel-title" id="edit-panel-date">Edit Entry</span>
                            <button class="edit-panel-close" onclick="hideEditPanel()">&times;</button>
                        </div>
                        <div class="edit-panel-grid">
                            <div class="input-group">
                                <label>Weight (kg)</label>
                                <input type="number" id="edit-weight" step="0.1" min="20" max="300" oninput="validateEditInputs()">
                                <div class="error-msg" id="edit-weight-error">Must be 20-300 kg</div>
                            </div>
                            <div class="input-group">
                                <label>Body Fat %</label>
                                <input type="number" id="edit-bf" step="0.1" min="1" max="60" oninput="validateEditInputs()">
                                <div class="error-msg" id="edit-bf-error">Must be 1-60%</div>
                            </div>
                        </div>
                        <div class="edit-panel-actions">
                            <button class="btn-save" id="edit-save-btn" onclick="saveEdit()">Save Changes</button>
                            <button class="btn-delete" onclick="deleteEntry()">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="history-title">Trend</div>
                        <div class="chart-range">
                            <button class="active" data-range="7">7D</button>
                            <button data-range="14">14D</button>
                            <button data-range="30">30D</button>
                            <button data-range="60">60D</button>
                            <button data-range="90">90D</button>
                        </div>
                    </div>
                    <div class="charts-container">
                        <div class="chart-section">
                            <div class="chart-title">Weight (kg)</div>
                            <div class="chart-stat-inline">
                                <span class="chart-stat-label">Avg</span>
                                <span class="chart-stat-value weight" id="avg-weight">--</span>
                            </div>
                            <div class="chart-wrap">
                                <canvas id="weight-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-section">
                            <div class="chart-title">Body Fat %</div>
                            <div class="chart-stat-inline">
                                <span class="chart-stat-label">Avg</span>
                                <span class="chart-stat-value bf" id="avg-bf">--</span>
                            </div>
                            <div class="chart-wrap">
                                <canvas id="bf-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Tab -->
    <div class="tab-content" id="tab-workout">
        <div class="card">
            <div class="card-header"><h2>Today's Workout</h2></div>
            <div class="card-body">
                <div class="workout-section-label">Strength (PPL)</div>
                <div class="workout-selector">
                    <button class="workout-btn push" data-workout="push" onclick="toggleWorkout('push')">
                        <div class="workout-icon">ðŸ’ª</div>
                        Push
                    </button>
                    <button class="workout-btn pull" data-workout="pull" onclick="toggleWorkout('pull')">
                        <div class="workout-icon">ðŸ‹ï¸</div>
                        Pull
                    </button>
                    <button class="workout-btn legs" data-workout="legs" onclick="toggleWorkout('legs')">
                        <div class="workout-icon">ðŸ¦µ</div>
                        Legs
                    </button>
                    <button class="workout-btn rest" data-workout="rest" onclick="toggleWorkout('rest')">
                        <div class="workout-icon">ðŸ˜´</div>
                        Rest
                    </button>
                </div>
                <div id="exercise-panels-today"></div>
                <div class="workout-section-label">Cardio & Steps</div>
                <div class="cardio-row">
                    <div class="workout-selector">
                        <button class="workout-btn zone2" data-workout="zone2" onclick="toggleWorkout('zone2')">
                            <div class="workout-icon">ðŸš´</div>
                            Zone 2
                        </button>
                        <button class="workout-btn hiit" data-workout="hiit" onclick="toggleWorkout('hiit')">
                            <div class="workout-icon">âš¡</div>
                            HIIT
                        </button>
                    </div>
                    <div class="steps-inline">
                        <span class="steps-icon">ðŸ‘Ÿ</span>
                        <input type="number" id="steps-input" placeholder="0" min="0" max="100000" oninput="saveSteps()">
                        <span class="steps-label">steps</span>
                    </div>
                </div>
                <div class="workout-week">
                    <div class="history-title">This Week (click to edit)</div>
                    <div class="week-grid" id="workout-week"></div>
                    <div class="edit-panel" id="workout-edit-panel">
                        <div class="edit-panel-header">
                            <span class="edit-panel-title" id="workout-edit-date">Edit Workout</span>
                            <button class="edit-panel-close" onclick="hideWorkoutEditPanel()">&times;</button>
                        </div>
                        <div class="workout-section-label">Strength (PPL)</div>
                        <div class="workout-selector">
                            <button class="workout-btn push" data-edit-workout="push" onclick="toggleEditWorkout('push')">
                                <div class="workout-icon">ðŸ’ª</div>
                                Push
                            </button>
                            <button class="workout-btn pull" data-edit-workout="pull" onclick="toggleEditWorkout('pull')">
                                <div class="workout-icon">ðŸ‹ï¸</div>
                                Pull
                            </button>
                            <button class="workout-btn legs" data-edit-workout="legs" onclick="toggleEditWorkout('legs')">
                                <div class="workout-icon">ðŸ¦µ</div>
                                Legs
                            </button>
                            <button class="workout-btn rest" data-edit-workout="rest" onclick="toggleEditWorkout('rest')">
                                <div class="workout-icon">ðŸ˜´</div>
                                Rest
                            </button>
                        </div>
                        <div class="workout-section-label">Cardio & Steps</div>
                        <div class="cardio-row">
                            <div class="workout-selector">
                                <button class="workout-btn zone2" data-edit-workout="zone2" onclick="toggleEditWorkout('zone2')">
                                    <div class="workout-icon">ðŸš´</div>
                                    Zone 2
                                </button>
                                <button class="workout-btn hiit" data-edit-workout="hiit" onclick="toggleEditWorkout('hiit')">
                                    <div class="workout-icon">âš¡</div>
                                    HIIT
                                </button>
                            </div>
                            <div class="steps-inline">
                                <span class="steps-icon">ðŸ‘Ÿ</span>
                                <input type="number" id="edit-steps-input" placeholder="0" min="0" max="100000">
                                <span class="steps-label">steps</span>
                            </div>
                        </div>
                        <div id="exercise-panels-edit"></div>
                        <div class="edit-panel-actions" style="margin-top: 12px;">
                            <button class="btn-save" onclick="saveWorkoutEdit()">Save Changes</button>
                            <button class="btn-delete" onclick="deleteWorkoutEntry()">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <datalist id="exercises-push">
            <option value="Bench Press">
            <option value="Overhead Press">
            <option value="Incline DB Press">
            <option value="Dips">
            <option value="Lateral Raises">
            <option value="Tricep Pushdowns">
            <option value="Cable Fly">
            <option value="Machine Fly">
        </datalist>
        <datalist id="exercises-pull">
            <option value="Pull-ups">
            <option value="Barbell Rows">
            <option value="Face Pulls">
            <option value="Bayesian Cable Curl">
            <option value="Hammer Curl">
            <option value="Barbell Curl">
            <option value="Lat Pulldown">
            <option value="Cable Rows">
        </datalist>
        <datalist id="exercises-legs">
            <option value="Barbell Squat">
            <option value="Goblet Squat">
            <option value="Bulgarian Split Squat">
            <option value="Romanian Deadlifts">
            <option value="Leg Press">
            <option value="Leg Curls">
            <option value="Leg Extension">
            <option value="Calf Raises">
            <option value="Lunges">
        </datalist>
    </div>

</div>

<script>
const STORAGE_KEY = 'healthTracker';

const DEFAULT_SUPPLEMENTS = [
    { id: 'mag-taurate', name: 'Magnesium Taurate', dose: '125-150mg (Elemental)', timeSlot: 'morning', tags: [], optional: false, cycle: null, order: 0 },
    { id: 'd3-k2', name: 'Vitamin D3 + K2', dose: '2000 IU / 50mcg', timeSlot: 'morning', tags: ['With Fat'], optional: false, cycle: null, order: 1 },
    { id: 'omega3', name: 'Omega-3', dose: '1000-2000mg (High EPA)', timeSlot: 'morning', tags: ['With Fat'], optional: false, cycle: null, order: 2 },
    { id: 'boron', name: 'Boron', dose: '3-6mg', timeSlot: 'morning', tags: [], optional: false, cycle: { key: 'boron', on: 14, off: 7 }, order: 3 },
    { id: 'b-complex', name: 'B-Complex', dose: '1 Capsule (Methylated)', timeSlot: 'morning', tags: [], optional: false, cycle: null, order: 4 },
    { id: 'hair-am', name: 'Hair Loss Treatment', dose: '1 Pill', timeSlot: 'morning', tags: [], optional: false, cycle: null, order: 5 },
    { id: 'creatine', name: 'Creatine Monohydrate', dose: '5g', timeSlot: 'morning', tags: [], optional: false, cycle: null, order: 6 },
    { id: 'selenium', name: 'Selenium', dose: '200mcg (Selenomethionine)', timeSlot: 'afternoon', tags: [], optional: false, cycle: null, order: 0 },
    { id: 'zinc', name: 'Zinc Picolinate', dose: '15-25mg (if needed beyond hair treatment)', timeSlot: 'evening', tags: [], optional: true, cycle: null, order: 0 },
    { id: 'mag-glycinate', name: 'Magnesium Bisglycinate', dose: '150-200mg (Elemental)', timeSlot: 'evening', tags: [], optional: false, cycle: null, order: 1 },
    { id: 'ashwagandha', name: 'Ashwagandha', dose: '300-600mg (KSM-66)', timeSlot: 'evening', tags: [], optional: false, cycle: { key: 'ashwa', on: 30, off: 7 }, order: 2 },
    { id: 'hair-pm', name: 'Hair Loss Treatment', dose: '1 Pill', timeSlot: 'evening', tags: [], optional: false, cycle: null, order: 3 }
];

const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

function getToday() {
    return new Date().toISOString().split('T')[0];
}

function getData() {
    const defaults = {
        supplements: { date: getToday(), checked: {}, streak: 0, lastCompleted: null },
        cycles: {},
        weight: {},
        workouts: {},
        steps: {},
        exercises: {},
        supplementDefs: []
    };
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) {
            defaults.supplementDefs = JSON.parse(JSON.stringify(DEFAULT_SUPPLEMENTS));
            defaults.cycles = buildDefaultCycles(defaults.supplementDefs);
            return defaults;
        }
        const data = JSON.parse(saved);
        const result = {
            supplements: { ...defaults.supplements, ...data.supplements },
            cycles: data.cycles || {},
            weight: data.weight || {},
            workouts: data.workouts || {},
            steps: data.steps || {},
            exercises: data.exercises || {},
            supplementDefs: data.supplementDefs || []
        };
        // Migration: populate supplementDefs if missing
        if (!result.supplementDefs.length) {
            result.supplementDefs = JSON.parse(JSON.stringify(DEFAULT_SUPPLEMENTS));
        }
        // Ensure cycles exist for all cycling supplements
        result.supplementDefs.forEach(s => {
            if (s.cycle && !result.cycles[s.cycle.key]) {
                result.cycles[s.cycle.key] = { startDate: getToday() };
            }
        });
        return result;
    } catch {
        defaults.supplementDefs = JSON.parse(JSON.stringify(DEFAULT_SUPPLEMENTS));
        defaults.cycles = buildDefaultCycles(defaults.supplementDefs);
        return defaults;
    }
}

function buildDefaultCycles(defs) {
    const cycles = {};
    defs.forEach(s => {
        if (s.cycle) cycles[s.cycle.key] = { startDate: getToday() };
    });
    return cycles;
}

function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
}

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
});

// Render supplements dynamically
const SLOT_LABELS = { morning: 'Morning (Brain & Heart)', afternoon: 'Afternoon', evening: 'Evening (Stress & Sleep)' };

function renderSupplements() {
    const data = getData();
    const defs = data.supplementDefs;
    const groups = { morning: [], afternoon: [], evening: [] };
    defs.forEach(s => {
        if (groups[s.timeSlot]) groups[s.timeSlot].push(s);
    });
    ['morning', 'afternoon', 'evening'].forEach(slot => {
        groups[slot].sort((a, b) => a.order - b.order);
        const container = document.getElementById('supp-list-' + slot);
        if (!groups[slot].length) {
            container.innerHTML = '';
            return;
        }
        let html = `<div class="card"><div class="card-header"><h2>${SLOT_LABELS[slot]}</h2></div>`;
        groups[slot].forEach(s => {
            const optClass = s.optional ? ' optional' : '';
            html += `<div class="supp-item${optClass}" data-id="${s.id}">`;
            html += `<input type="checkbox" class="supp-check" onchange="updateSupplements()">`;
            html += `<div class="supp-info"><div class="supp-name">${escHtml(s.name)}`;
            if (s.tags) s.tags.forEach(t => { html += `<span class="tag">${escHtml(t)}</span>`; });
            if (s.cycle) html += `<span class="badge on" id="${s.cycle.key}-inline"><span class="badge-dot"></span>ON</span>`;
            if (s.optional) html += `<span class="tag">Optional</span>`;
            html += `</div><div class="supp-dose">${escHtml(s.dose)}</div></div></div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    });
}

function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function renderCycleStatus() {
    const data = getData();
    const cyclingSupps = data.supplementDefs.filter(s => s.cycle);
    const container = document.getElementById('cycle-status-card');
    if (!cyclingSupps.length) { container.innerHTML = ''; return; }
    let html = '<div class="card"><div class="card-header"><h2>Cycle Status</h2></div><div class="card-body">';
    cyclingSupps.forEach(s => {
        const key = s.cycle.key;
        html += `<div class="cycle-row"><span class="cycle-name">${escHtml(s.name)}</span>`;
        html += `<div class="cycle-meta"><span class="cycle-days" id="${key}-days">Day 1 of ${s.cycle.on}</span>`;
        html += `<span class="badge on" id="${key}-badge"><span class="badge-dot"></span>ON</span>`;
        html += `<button class="btn-small" onclick="resetCycle('${key}')">Reset</button></div></div>`;
    });
    html += '</div></div>';
    container.innerHTML = html;
}

// Cycles
function getCycleStatus(key, cycleDef) {
    const data = getData();
    if (!data.cycles[key]) return { isOn: true, currentDay: 1, totalDays: cycleDef.on };
    const start = new Date(data.cycles[key].startDate);
    const today = new Date(getToday());
    const daysPassed = Math.floor((today - start) / 86400000);
    const total = cycleDef.on + cycleDef.off;
    const dayInCycle = (daysPassed % total) + 1;
    const isOn = dayInCycle <= cycleDef.on;
    return {
        isOn,
        currentDay: isOn ? dayInCycle : dayInCycle - cycleDef.on,
        totalDays: isOn ? cycleDef.on : cycleDef.off
    };
}

function updateCycles() {
    const data = getData();
    const cyclingSupps = data.supplementDefs.filter(s => s.cycle);
    cyclingSupps.forEach(s => {
        const key = s.cycle.key;
        const status = getCycleStatus(key, s.cycle);
        const badgeClass = status.isOn ? 'on' : 'off';
        const badgeText = status.isOn ? 'ON' : 'OFF';

        const daysEl = document.getElementById(key + '-days');
        if (daysEl) daysEl.textContent = `Day ${status.currentDay} of ${status.totalDays}`;

        [key + '-badge', key + '-inline'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `badge ${badgeClass}`;
            el.innerHTML = `<span class="badge-dot"></span>${badgeText}`;
        });

        const item = document.querySelector(`[data-id="${s.id}"]`);
        if (item) {
            item.classList.toggle('disabled', !status.isOn);
            const cb = item.querySelector('input');
            cb.disabled = !status.isOn;
            if (!status.isOn) cb.checked = false;
        }
    });
}

function resetCycle(key) {
    const data = getData();
    const supp = data.supplementDefs.find(s => s.cycle && s.cycle.key === key);
    if (!supp || !confirm(`Reset ${supp.name} cycle?`)) return;
    data.cycles[key] = { startDate: getToday() };
    saveData(data);
    updateCycles();
    updateSupplements();
}

// Supplements
function updateSupplements() {
    const items = document.querySelectorAll('.supp-item');
    const requiredItems = document.querySelectorAll('.supp-item:not(.disabled):not(.optional)');
    const checkboxes = Array.from(requiredItems).map(item => item.querySelector('.supp-check'));
    const checked = checkboxes.filter(c => c.checked).length;
    const percent = checkboxes.length ? Math.round((checked / checkboxes.length) * 100) : 100;

    document.getElementById('progress-fill').style.width = percent + '%';
    document.getElementById('progress-percent').textContent = percent + '%';

    items.forEach(item => {
        const cb = item.querySelector('.supp-check');
        item.classList.toggle('checked', cb.checked);
    });

    const data = getData();
    data.supplements.date = getToday();
    data.supplements.checked = {};
    items.forEach(item => {
        if (!item.classList.contains('disabled')) {
            data.supplements.checked[item.dataset.id] = item.querySelector('.supp-check').checked;
        }
    });

    if (percent === 100 && checkboxes.length > 0 && data.supplements.lastCompleted !== getToday()) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yStr = yesterday.toISOString().split('T')[0];
        data.supplements.streak = data.supplements.lastCompleted === yStr ? data.supplements.streak + 1 : 1;
        data.supplements.lastCompleted = getToday();
    }

    document.getElementById('stat-streak').textContent = data.supplements.streak;
    saveData(data);
}

function resetSupplements() {
    if (!confirm('Reset all supplements?')) return;
    document.querySelectorAll('.supp-check').forEach(cb => { if (!cb.disabled) cb.checked = false; });
    updateSupplements();
}

// Supplement Management Modal
function generateSuppId(name) {
    const base = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    const data = getData();
    const ids = data.supplementDefs.map(s => s.id);
    if (!ids.includes(base)) return base;
    let i = 2;
    while (ids.includes(base + '-' + i)) i++;
    return base + '-' + i;
}

function openSuppModal() {
    renderSuppModalList();
    document.getElementById('supp-modal').classList.add('visible');
}

function closeSuppModal() {
    document.getElementById('supp-modal').classList.remove('visible');
}

function renderSuppModalList() {
    const data = getData();
    const defs = data.supplementDefs;
    const groups = { morning: [], afternoon: [], evening: [] };
    defs.forEach(s => { if (groups[s.timeSlot]) groups[s.timeSlot].push(s); });
    let html = '';
    ['morning', 'afternoon', 'evening'].forEach(slot => {
        const items = groups[slot].sort((a, b) => a.order - b.order);
        if (!items.length) return;
        html += `<div class="supp-modal-group"><h3>${SLOT_LABELS[slot]}</h3>`;
        items.forEach(s => {
            html += `<div class="supp-modal-row" id="supp-row-${s.id}">`;
            html += `<div class="supp-modal-row-info"><div class="supp-modal-row-name">${escHtml(s.name)}`;
            if (s.optional) html += ' <span class="tag">Optional</span>';
            if (s.cycle) html += ` <span class="tag">${s.cycle.on}on/${s.cycle.off}off</span>`;
            html += `</div><div class="supp-modal-row-dose">${escHtml(s.dose)}</div></div>`;
            html += `<div class="supp-modal-row-actions">`;
            html += `<button class="btn-edit-supp" onclick="editSupplement('${s.id}')">Edit</button>`;
            html += `<button class="btn-del-supp" onclick="deleteSupplement('${s.id}')">Delete</button>`;
            html += `</div></div>`;
        });
        html += '</div>';
    });
    document.getElementById('supp-modal-list').innerHTML = html;
}

function editSupplement(id) {
    const data = getData();
    const s = data.supplementDefs.find(d => d.id === id);
    if (!s) return;
    const row = document.getElementById('supp-row-' + id);
    if (!row) return;
    row.outerHTML = `<div class="supp-modal-edit-row" id="supp-edit-${id}">
        <input type="text" id="edit-name-${id}" value="${escAttr(s.name)}" placeholder="Name">
        <input type="text" id="edit-dose-${id}" value="${escAttr(s.dose)}" placeholder="Dose">
        <select id="edit-slot-${id}">
            <option value="morning"${s.timeSlot==='morning'?' selected':''}>Morning</option>
            <option value="afternoon"${s.timeSlot==='afternoon'?' selected':''}>Afternoon</option>
            <option value="evening"${s.timeSlot==='evening'?' selected':''}>Evening</option>
        </select>
        <label><input type="checkbox" id="edit-opt-${id}"${s.optional?' checked':''}> Optional</label>
        <div class="supp-modal-edit-actions">
            <button class="btn-paste-cancel" onclick="renderSuppModalList()">Cancel</button>
            <button class="btn-paste-load" onclick="saveSupplement('${id}')">Save</button>
        </div>
    </div>`;
}

function escAttr(str) {
    return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function saveSupplement(id) {
    const name = document.getElementById('edit-name-' + id).value.trim();
    const dose = document.getElementById('edit-dose-' + id).value.trim();
    const slot = document.getElementById('edit-slot-' + id).value;
    const optional = document.getElementById('edit-opt-' + id).checked;
    if (!name) { showToast('Name is required', true); return; }
    const data = getData();
    const s = data.supplementDefs.find(d => d.id === id);
    if (!s) return;
    s.name = name;
    s.dose = dose;
    s.timeSlot = slot;
    s.optional = optional;
    saveData(data);
    renderSuppModalList();
    renderSupplements();
    renderCycleStatus();
    restoreCheckboxState();
    updateCycles();
    updateSupplements();
}

function deleteSupplement(id) {
    const data = getData();
    const s = data.supplementDefs.find(d => d.id === id);
    if (!s || !confirm(`Delete "${s.name}"?`)) return;
    // Clean up cycle data
    if (s.cycle && data.cycles[s.cycle.key]) {
        delete data.cycles[s.cycle.key];
    }
    // Remove checked state
    delete data.supplements.checked[id];
    data.supplementDefs = data.supplementDefs.filter(d => d.id !== id);
    saveData(data);
    renderSuppModalList();
    renderSupplements();
    renderCycleStatus();
    restoreCheckboxState();
    updateCycles();
    updateSupplements();
}

function addSupplement() {
    const name = document.getElementById('add-supp-name').value.trim();
    const dose = document.getElementById('add-supp-dose').value.trim();
    const slot = document.getElementById('add-supp-slot').value;
    const optional = document.getElementById('add-supp-optional').checked;
    if (!name) { showToast('Name is required', true); return; }
    const data = getData();
    const sameSlot = data.supplementDefs.filter(s => s.timeSlot === slot);
    const maxOrder = sameSlot.length ? Math.max(...sameSlot.map(s => s.order)) + 1 : 0;
    data.supplementDefs.push({
        id: generateSuppId(name),
        name, dose, timeSlot: slot,
        tags: [], optional, cycle: null,
        order: maxOrder
    });
    saveData(data);
    // Clear form
    document.getElementById('add-supp-name').value = '';
    document.getElementById('add-supp-dose').value = '';
    document.getElementById('add-supp-optional').checked = false;
    renderSuppModalList();
    renderSupplements();
    restoreCheckboxState();
    updateCycles();
    updateSupplements();
    showToast(`Added "${name}"`);
}

function resetSupplementDefs() {
    if (!confirm('Reset supplement list to defaults? This will remove any custom supplements.')) return;
    const data = getData();
    data.supplementDefs = JSON.parse(JSON.stringify(DEFAULT_SUPPLEMENTS));
    data.cycles = buildDefaultCycles(data.supplementDefs);
    saveData(data);
    renderSuppModalList();
    renderSupplements();
    renderCycleStatus();
    restoreCheckboxState();
    updateCycles();
    updateSupplements();
    showToast('Reset to defaults');
}

function restoreCheckboxState() {
    const data = getData();
    document.querySelectorAll('.supp-item').forEach(item => {
        item.querySelector('.supp-check').checked = data.supplements.checked[item.dataset.id] || false;
    });
}

// Weight Validation
function validateWeight(value) {
    if (value === '' || value === null || isNaN(value)) return true; // empty is ok
    const num = parseFloat(value);
    return num >= 20 && num <= 300;
}

function validateBf(value) {
    if (value === '' || value === null || isNaN(value)) return true; // empty is ok
    const num = parseFloat(value);
    return num >= 1 && num <= 60;
}

function validateWeightInputs() {
    const weightInput = document.getElementById('weight-input');
    const bfInput = document.getElementById('bf-input');
    const weightError = document.getElementById('weight-error');
    const bfError = document.getElementById('bf-error');
    const logBtn = document.getElementById('log-weight-btn');

    const weightVal = weightInput.value;
    const bfVal = bfInput.value;

    const weightValid = validateWeight(weightVal);
    const bfValid = validateBf(bfVal);

    weightInput.classList.toggle('error', weightVal !== '' && !weightValid);
    weightError.classList.toggle('show', weightVal !== '' && !weightValid);

    bfInput.classList.toggle('error', bfVal !== '' && !bfValid);
    bfError.classList.toggle('show', bfVal !== '' && !bfValid);

    const hasValue = weightVal !== '' || bfVal !== '';
    logBtn.disabled = !hasValue || !weightValid || !bfValid;

    return weightValid && bfValid && hasValue;
}

// Weight
function logWeight() {
    if (!validateWeightInputs()) return;

    const weight = parseFloat(document.getElementById('weight-input').value);
    const bf = parseFloat(document.getElementById('bf-input').value);
    if (!weight && !bf) return;

    const data = getData();
    data.weight[getToday()] = { weight: weight || null, bf: bf || null };
    saveData(data);

    document.getElementById('weight-input').value = '';
    document.getElementById('bf-input').value = '';
    document.getElementById('log-weight-btn').disabled = true;

    updateWeightDisplay();
}

function updateWeightDisplay() {
    const data = getData();
    const today = new Date();
    const grid = document.getElementById('weight-history');
    grid.innerHTML = '';

    let latestWeight = '--';
    let latestBf = '--';

    for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const entry = data.weight[dateStr];
        const isToday = i === 0;
        const hasData = entry && (entry.weight || entry.bf);

        const div = document.createElement('div');
        div.className = 'history-day' + (isToday ? ' today' : '') + (!hasData ? ' empty' : ' has-data');
        div.dataset.date = dateStr;
        div.innerHTML = `
            <div class="day-label">${DAYS[d.getDay()]}</div>
            <div class="day-weight">${entry?.weight ? entry.weight.toFixed(1) + ' kg' : '--'}</div>
            <div class="day-bf">${entry?.bf ? entry.bf.toFixed(1) + '%' : ''}</div>
        `;

        div.addEventListener('click', () => showEditPanel(dateStr));

        grid.appendChild(div);

        if (entry?.weight) latestWeight = entry.weight.toFixed(1);
        if (entry?.bf) latestBf = entry.bf.toFixed(1);
    }

    drawCharts();
}

// Edit Panel
let editingDate = null;

function showEditPanel(dateStr) {
    const data = getData();
    const entry = data.weight[dateStr];

    editingDate = dateStr;

    // Format date for display
    const d = new Date(dateStr + 'T00:00:00');
    const formatted = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    document.getElementById('edit-panel-date').textContent = `${entry ? 'Edit' : 'Add'}: ${formatted}`;

    // Populate fields
    document.getElementById('edit-weight').value = entry?.weight || '';
    document.getElementById('edit-bf').value = entry?.bf || '';

    // Reset validation state
    document.getElementById('edit-weight').classList.remove('error');
    document.getElementById('edit-bf').classList.remove('error');
    document.getElementById('edit-weight-error').classList.remove('show');
    document.getElementById('edit-bf-error').classList.remove('show');
    document.getElementById('edit-save-btn').disabled = false;

    // Highlight the selected day
    document.querySelectorAll('.history-day').forEach(el => {
        el.classList.toggle('editing', el.dataset.date === dateStr);
    });

    // Show panel
    document.getElementById('edit-panel').classList.add('active');
}

function hideEditPanel() {
    editingDate = null;
    document.getElementById('edit-panel').classList.remove('active');
    document.querySelectorAll('.history-day').forEach(el => {
        el.classList.remove('editing');
    });
}

function validateEditInputs() {
    const weightInput = document.getElementById('edit-weight');
    const bfInput = document.getElementById('edit-bf');
    const weightError = document.getElementById('edit-weight-error');
    const bfError = document.getElementById('edit-bf-error');
    const saveBtn = document.getElementById('edit-save-btn');

    const weightVal = weightInput.value;
    const bfVal = bfInput.value;

    const weightValid = validateWeight(weightVal);
    const bfValid = validateBf(bfVal);

    weightInput.classList.toggle('error', weightVal !== '' && !weightValid);
    weightError.classList.toggle('show', weightVal !== '' && !weightValid);

    bfInput.classList.toggle('error', bfVal !== '' && !bfValid);
    bfError.classList.toggle('show', bfVal !== '' && !bfValid);

    const hasValue = weightVal !== '' || bfVal !== '';
    saveBtn.disabled = !hasValue || !weightValid || !bfValid;

    return weightValid && bfValid && hasValue;
}

function saveEdit() {
    if (!editingDate || !validateEditInputs()) return;

    const weight = parseFloat(document.getElementById('edit-weight').value);
    const bf = parseFloat(document.getElementById('edit-bf').value);

    const data = getData();
    data.weight[editingDate] = { weight: weight || null, bf: bf || null };
    saveData(data);

    hideEditPanel();
    updateWeightDisplay();
}

function deleteEntry() {
    if (!editingDate) return;

    const d = new Date(editingDate + 'T00:00:00');
    const formatted = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

    if (!confirm(`Delete weight entry for ${formatted}?`)) return;

    const data = getData();
    delete data.weight[editingDate];
    saveData(data);

    hideEditPanel();
    updateWeightDisplay();
}

// Chart
let chartRange = 7;

document.querySelectorAll('.chart-range button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-range button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        chartRange = parseInt(btn.dataset.range);
        document.querySelector('.charts-container').classList.toggle('stacked', chartRange >= 60);
        drawCharts();
    });
});

function drawCharts() {
    document.querySelectorAll('.chart-wrap canvas').forEach(c => { c.style.width = ''; c.style.height = ''; });
    drawWeightChart();
    drawBfChart();
}

function drawWeightChart() {
    const canvas = document.getElementById('weight-chart');
    const ctx = canvas.getContext('2d');
    const data = getData();

    // Set canvas size for sharp rendering
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';

    const width = rect.width;
    const height = rect.height;

    // Gather data points
    const points = [];
    const today = new Date();
    for (let i = chartRange - 1; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const entry = data.weight[dateStr];
        points.push({
            date: d,
            weight: entry?.weight || null
        });
    }

    // Check if we have any data
    const hasData = points.some(p => p.weight !== null);
    const weights = points.map(p => p.weight).filter(w => w !== null);

    // Calculate average
    const avgWeight = weights.length ? (weights.reduce((a, b) => a + b, 0) / weights.length) : null;
    document.getElementById('avg-weight').textContent = avgWeight ? avgWeight.toFixed(1) + ' kg' : '--';

    if (!hasData) {
        ctx.fillStyle = '#64748b';
        ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No data yet', width / 2, height / 2);
        return;
    }

    const minVal = Math.min(...weights) - 1;
    const maxVal = Math.max(...weights) + 1;

    const padding = { top: 10, right: 10, bottom: 20, left: 35 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // Clear canvas
    ctx.clearRect(0, 0, width, height);

    // Draw grid lines
    ctx.strokeStyle = '#1e293b';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
    }

    // Draw x-axis labels
    ctx.fillStyle = '#64748b';
    ctx.font = '9px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'center';
    const labelStep = chartRange <= 7 ? 1 : chartRange <= 14 ? 2 : chartRange <= 30 ? 5 : chartRange <= 60 ? 10 : 15;
    points.forEach((p, i) => {
        if (i % labelStep === 0 || i === points.length - 1) {
            const x = padding.left + (chartWidth / (points.length - 1)) * i;
            const label = p.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            ctx.fillText(label, x, height - 5);
        }
    });

    // Draw y-axis labels
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const val = minVal + ((maxVal - minVal) / 4) * (4 - i);
        const y = padding.top + (chartHeight / 4) * i;
        ctx.fillText(val.toFixed(1), padding.left - 5, y + 3);
    }

    // Helper to get Y position
    const getY = (val) => {
        return padding.top + chartHeight - ((val - minVal) / (maxVal - minVal)) * chartHeight;
    };

    // Draw line
    ctx.strokeStyle = '#60a5fa';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.beginPath();
    let started = false;
    points.forEach((p, i) => {
        if (p.weight !== null) {
            const x = padding.left + (chartWidth / (points.length - 1)) * i;
            const y = getY(p.weight);
            if (!started) {
                ctx.moveTo(x, y);
                started = true;
            } else {
                ctx.lineTo(x, y);
            }
        }
    });
    ctx.stroke();

    // Draw points
    ctx.fillStyle = '#60a5fa';
    points.forEach((p, i) => {
        if (p.weight !== null) {
            const x = padding.left + (chartWidth / (points.length - 1)) * i;
            const y = getY(p.weight);
            ctx.beginPath();
            ctx.arc(x, y, chartRange >= 60 ? 2.5 : 4, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}

function drawBfChart() {
    const canvas = document.getElementById('bf-chart');
    const ctx = canvas.getContext('2d');
    const data = getData();

    // Set canvas size for sharp rendering
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';

    const width = rect.width;
    const height = rect.height;

    // Gather data points
    const points = [];
    const today = new Date();
    for (let i = chartRange - 1; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const entry = data.weight[dateStr];
        points.push({
            date: d,
            bf: entry?.bf || null
        });
    }

    // Check if we have any data
    const hasData = points.some(p => p.bf !== null);
    const bfs = points.map(p => p.bf).filter(b => b !== null);

    // Calculate average
    const avgBf = bfs.length ? (bfs.reduce((a, b) => a + b, 0) / bfs.length) : null;
    document.getElementById('avg-bf').textContent = avgBf ? avgBf.toFixed(1) + '%' : '--';

    if (!hasData) {
        ctx.fillStyle = '#64748b';
        ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No data yet', width / 2, height / 2);
        return;
    }

    const minVal = Math.min(...bfs) - 2;
    const maxVal = Math.max(...bfs) + 2;

    const padding = { top: 10, right: 10, bottom: 20, left: 35 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // Clear canvas
    ctx.clearRect(0, 0, width, height);

    // Draw grid lines
    ctx.strokeStyle = '#1e293b';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
    }

    // Draw x-axis labels
    ctx.fillStyle = '#64748b';
    ctx.font = '9px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'center';
    const labelStep = chartRange <= 7 ? 1 : chartRange <= 14 ? 2 : chartRange <= 30 ? 5 : chartRange <= 60 ? 10 : 15;
    points.forEach((p, i) => {
        if (i % labelStep === 0 || i === points.length - 1) {
            const x = padding.left + (chartWidth / (points.length - 1)) * i;
            const label = p.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            ctx.fillText(label, x, height - 5);
        }
    });

    // Draw y-axis labels
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const val = minVal + ((maxVal - minVal) / 4) * (4 - i);
        const y = padding.top + (chartHeight / 4) * i;
        ctx.fillText(val.toFixed(1), padding.left - 5, y + 3);
    }

    // Helper to get Y position
    const getY = (val) => {
        return padding.top + chartHeight - ((val - minVal) / (maxVal - minVal)) * chartHeight;
    };

    // Draw line
    ctx.strokeStyle = '#a78bfa';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.beginPath();
    let started = false;
    points.forEach((p, i) => {
        if (p.bf !== null) {
            const x = padding.left + (chartWidth / (points.length - 1)) * i;
            const y = getY(p.bf);
            if (!started) {
                ctx.moveTo(x, y);
                started = true;
            } else {
                ctx.lineTo(x, y);
            }
        }
    });
    ctx.stroke();

    // Draw points
    ctx.fillStyle = '#a78bfa';
    points.forEach((p, i) => {
        if (p.bf !== null) {
            const x = padding.left + (chartWidth / (points.length - 1)) * i;
            const y = getY(p.bf);
            ctx.beginPath();
            ctx.arc(x, y, chartRange >= 60 ? 2.5 : 4, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}

// Workouts
const WORKOUT_LABELS = {
    push: 'Push',
    pull: 'Pull',
    legs: 'Legs',
    rest: 'Rest',
    zone2: 'Zone 2',
    hiit: 'HIIT'
};

let stepsTimeout = null;

function saveSteps() {
    const input = document.getElementById('steps-input');
    const steps = parseInt(input.value) || 0;

    // Debounce saving
    clearTimeout(stepsTimeout);
    stepsTimeout = setTimeout(() => {
        const data = getData();
        if (!data.steps) data.steps = {};

        if (steps > 0) {
            data.steps[getToday()] = steps;
        } else {
            delete data.steps[getToday()];
        }

        saveData(data);
        updateWorkoutDisplay();
    }, 500);
}

function toggleWorkout(type) {
    const data = getData();
    let current = data.workouts[getToday()] || [];

    // Convert old string format to array if needed
    if (typeof current === 'string') {
        current = current ? [current] : [];
    }

    if (type === 'rest') {
        // Rest is exclusive - clears everything or toggles off
        if (current.includes('rest')) {
            current = [];
        } else {
            current = ['rest'];
        }
    } else {
        // Remove rest if adding other workout
        current = current.filter(w => w !== 'rest');

        // Toggle the workout
        if (current.includes(type)) {
            current = current.filter(w => w !== type);
        } else {
            current.push(type);
        }
    }

    if (current.length === 0) {
        delete data.workouts[getToday()];
    } else {
        data.workouts[getToday()] = current;
    }

    saveData(data);
    updateWorkoutDisplay();
    renderExercisePanels();
}

function updateWorkoutDisplay() {
    const data = getData();
    const today = new Date();
    let todayWorkouts = data.workouts[getToday()] || [];

    // Convert old string format to array
    if (typeof todayWorkouts === 'string') {
        todayWorkouts = todayWorkouts ? [todayWorkouts] : [];
    }

    document.querySelectorAll('.workout-btn[data-workout]').forEach(btn => {
        btn.classList.toggle('active', todayWorkouts.includes(btn.dataset.workout));
    });

    // Load today's steps
    const stepsInput = document.getElementById('steps-input');
    const todaySteps = data.steps[getToday()] || '';
    if (stepsInput && document.activeElement !== stepsInput) {
        stepsInput.value = todaySteps || '';
    }

    const grid = document.getElementById('workout-week');
    grid.innerHTML = '';

    // Last 7 days
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - 6);

    for (let i = 0; i < 7; i++) {
        const d = new Date(startDate);
        d.setDate(d.getDate() + i);
        const dateStr = d.toISOString().split('T')[0];
        let workouts = data.workouts[dateStr] || [];
        const steps = data.steps[dateStr] || 0;
        const isToday = dateStr === getToday();

        // Convert old string format
        if (typeof workouts === 'string') {
            workouts = workouts ? [workouts] : [];
        }

        const hasData = workouts.length > 0 || steps > 0;
        const div = document.createElement('div');
        div.className = 'week-day' + (isToday ? ' today' : '') + (hasData ? ' has-data' : '');
        div.dataset.date = dateStr;

        let typesHtml;
        if (workouts.length === 0) {
            typesHtml = '<div class="wd-type empty">-</div>';
        } else {
            typesHtml = workouts.map(w =>
                `<div class="wd-type ${w}">${WORKOUT_LABELS[w] || w}</div>`
            ).join('');
        }

        // Format steps display
        let stepsHtml = '';
        if (steps > 0) {
            const stepsK = steps >= 1000 ? (steps / 1000).toFixed(1) + 'k' : steps;
            const isGood = steps >= 10000;
            stepsHtml = `<div class="wd-steps${isGood ? ' good' : ''}">${stepsK}</div>`;
        }

        div.innerHTML = `
            <div class="wd-label">${DAYS[d.getDay()]}</div>
            <div class="wd-types">${typesHtml}</div>
            ${stepsHtml}
        `;

        div.addEventListener('click', () => showWorkoutEditPanel(dateStr));

        grid.appendChild(div);
    }

    // Restore editing highlight if edit panel is open
    if (editingWorkoutDate) {
        document.querySelectorAll('.week-day').forEach(el => {
            el.classList.toggle('editing', el.dataset.date === editingWorkoutDate);
        });
    }

    renderExercisePanels();
}

// Workout Edit Panel
let editingWorkoutDate = null;
let editWorkoutTypes = [];

function showWorkoutEditPanel(dateStr) {
    const data = getData();
    let workouts = data.workouts[dateStr] || [];
    const steps = data.steps[dateStr] || 0;

    if (typeof workouts === 'string') {
        workouts = workouts ? [workouts] : [];
    }

    editingWorkoutDate = dateStr;
    editWorkoutTypes = [...workouts];

    // Format date for display
    const hasEntry = workouts.length > 0 || steps > 0;
    const d = new Date(dateStr + 'T00:00:00');
    const formatted = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    document.getElementById('workout-edit-date').textContent = `${hasEntry ? 'Edit' : 'Add'}: ${formatted}`;

    // Update edit buttons
    document.querySelectorAll('[data-edit-workout]').forEach(btn => {
        btn.classList.toggle('active', editWorkoutTypes.includes(btn.dataset.editWorkout));
    });

    // Set steps
    document.getElementById('edit-steps-input').value = steps || '';

    // Highlight the selected day
    document.querySelectorAll('.week-day').forEach(el => {
        el.classList.toggle('editing', el.dataset.date === dateStr);
    });

    // Show panel
    document.getElementById('workout-edit-panel').classList.add('active');
    renderEditExercisePanels();
}

function hideWorkoutEditPanel() {
    editingWorkoutDate = null;
    editWorkoutTypes = [];
    document.getElementById('workout-edit-panel').classList.remove('active');
    document.getElementById('exercise-panels-edit').innerHTML = '';
    document.querySelectorAll('.week-day').forEach(el => {
        el.classList.remove('editing');
    });
}

function toggleEditWorkout(type) {
    if (type === 'rest') {
        if (editWorkoutTypes.includes('rest')) {
            editWorkoutTypes = [];
        } else {
            editWorkoutTypes = ['rest'];
        }
    } else {
        editWorkoutTypes = editWorkoutTypes.filter(w => w !== 'rest');
        if (editWorkoutTypes.includes(type)) {
            editWorkoutTypes = editWorkoutTypes.filter(w => w !== type);
        } else {
            editWorkoutTypes.push(type);
        }
    }

    // Update edit buttons
    document.querySelectorAll('[data-edit-workout]').forEach(btn => {
        btn.classList.toggle('active', editWorkoutTypes.includes(btn.dataset.editWorkout));
    });
    renderEditExercisePanels();
}

function saveWorkoutEdit() {
    if (!editingWorkoutDate) return;

    const data = getData();
    const steps = parseInt(document.getElementById('edit-steps-input').value) || 0;

    if (editWorkoutTypes.length > 0) {
        data.workouts[editingWorkoutDate] = [...editWorkoutTypes];
    } else {
        delete data.workouts[editingWorkoutDate];
    }

    if (steps > 0) {
        data.steps[editingWorkoutDate] = steps;
    } else {
        delete data.steps[editingWorkoutDate];
    }

    saveData(data);
    hideWorkoutEditPanel();
    updateWorkoutDisplay();
}

function deleteWorkoutEntry() {
    if (!editingWorkoutDate) return;

    const d = new Date(editingWorkoutDate + 'T00:00:00');
    const formatted = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

    if (!confirm(`Delete workout data for ${formatted}?`)) return;

    const data = getData();
    delete data.workouts[editingWorkoutDate];
    delete data.steps[editingWorkoutDate];
    delete data.exercises[editingWorkoutDate];
    saveData(data);

    hideWorkoutEditPanel();
    updateWorkoutDisplay();
}

// Exercise Tracking
const STRENGTH_TYPES = ['push', 'pull', 'legs'];
const STRENGTH_LABELS = { push: 'Push', pull: 'Pull', legs: 'Legs' };

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function getExercises(dateStr, type) {
    const data = getData();
    return (data.exercises[dateStr] && data.exercises[dateStr][type]) || [];
}

function saveExercises(dateStr, type, exercises) {
    const data = getData();
    if (!data.exercises[dateStr]) data.exercises[dateStr] = {};

    // Filter out completely empty rows
    const cleaned = exercises.filter(ex => ex.name || ex.sets || ex.reps);
    if (cleaned.length > 0) {
        data.exercises[dateStr][type] = cleaned;
    } else {
        delete data.exercises[dateStr][type];
        // Clean up empty date entry
        if (Object.keys(data.exercises[dateStr]).length === 0) {
            delete data.exercises[dateStr];
        }
    }
    saveData(data);
}

function lookupExerciseHistory(name, type, excludeDate) {
    if (!name || !name.trim()) return [];
    const data = getData();
    const nameLower = name.trim().toLowerCase();
    const results = [];
    const dates = Object.keys(data.exercises || {}).sort().reverse();
    for (const d of dates) {
        if (d === excludeDate) continue;
        const typeExercises = data.exercises[d][type];
        if (!typeExercises) continue;
        for (const ex of typeExercises) {
            if (ex.name && ex.name.trim().toLowerCase() === nameLower && (ex.sets || ex.reps || ex.kg)) {
                results.push({ date: d, sets: ex.sets, reps: ex.reps, kg: ex.kg });
                break;
            }
        }
        if (results.length >= 3) break;
    }
    return results;
}

function formatHistoryDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function renderExerciseHistory(context, type, index, name) {
    const el = document.getElementById(`history-${context}-${type}-${index}`);
    if (!el) return;
    const excludeDate = context === 'edit' ? editingWorkoutDate : getToday();
    const history = lookupExerciseHistory(name, type, excludeDate);
    if (history.length === 0) {
        el.classList.remove('visible');
        el.innerHTML = '';
        return;
    }
    const parts = history.map(h => {
        const sets = h.sets || '?';
        const reps = h.reps || '?';
        const kg = h.kg ? ` @ ${h.kg}kg` : '';
        return `<span class="hist-date">${formatHistoryDate(h.date)}</span>: ${sets}&times;${reps}${kg}`;
    });
    el.innerHTML = '<span class="hist-label">Previous:</span> ' + parts.join(' &middot; ');
    el.classList.add('visible');
}

function renderAllExerciseHistories(context) {
    const containerId = context === 'edit' ? 'exercise-panels-edit' : 'exercise-panels-today';
    const container = document.getElementById(containerId);
    if (!container) return;
    container.querySelectorAll('.exercise-entry').forEach(entry => {
        const histEl = entry.querySelector('.exercise-history');
        if (!histEl || !histEl.id) return;
        const parts = histEl.id.replace('history-', '').split('-');
        const ctx = parts[0];
        const type = parts[1];
        const idx = parseInt(parts[2], 10);
        const nameInput = entry.querySelector('.exercise-entry-top input[type="text"]');
        if (nameInput && nameInput.value.trim()) {
            renderExerciseHistory(ctx, type, idx, nameInput.value);
        }
    });
}

function buildExercisePanelHTML(type, exercises, context) {
    let rowsHtml = '';
    exercises.forEach((ex, i) => {
        rowsHtml += `<div class="exercise-entry">
            <div class="exercise-entry-top">
                <input type="text" list="exercises-${type}" value="${escapeHtml(ex.name || '')}" placeholder="Exercise name"
                    onchange="updateExercise('${context}','${type}',${i},'name',this.value); renderExerciseHistory('${context}','${type}',${i},this.value)"
                    oninput="updateExercise('${context}','${type}',${i},'name',this.value)">
                <button class="exercise-remove" onclick="removeExercise('${context}','${type}',${i})">&times;</button>
            </div>
            <div class="exercise-history" id="history-${context}-${type}-${i}"></div>
            <div class="exercise-entry-nums">
                <input type="number" value="${ex.sets || ''}" placeholder="Sets" min="0" max="99"
                    onchange="updateExercise('${context}','${type}',${i},'sets',this.value)">
                <input type="number" value="${ex.reps || ''}" placeholder="Reps" min="0" max="999"
                    onchange="updateExercise('${context}','${type}',${i},'reps',this.value)">
                <input type="number" value="${ex.kg || ''}" placeholder="Kg" min="0" max="999" step="0.5"
                    onchange="updateExercise('${context}','${type}',${i},'kg',this.value)">
            </div>
        </div>`;
    });

    return `<div class="exercise-panel ${type}">
        <div class="exercise-panel-header">${STRENGTH_LABELS[type]} Exercises</div>
        ${rowsHtml}
        <button class="exercise-add-btn" onclick="addExercise('${context}','${type}')">+ Add Exercise</button>
    </div>`;
}

function renderExercisePanels() {
    const container = document.getElementById('exercise-panels-today');
    if (!container) return;

    const data = getData();
    let todayWorkouts = data.workouts[getToday()] || [];
    if (typeof todayWorkouts === 'string') todayWorkouts = todayWorkouts ? [todayWorkouts] : [];

    const activeStrength = STRENGTH_TYPES.filter(t => todayWorkouts.includes(t));

    if (activeStrength.length === 0) {
        container.innerHTML = '';
        return;
    }

    let html = '';
    activeStrength.forEach(type => {
        const exercises = getExercises(getToday(), type);
        html += buildExercisePanelHTML(type, exercises, 'today');
    });
    container.innerHTML = html;
    renderAllExerciseHistories('today');
}

function renderEditExercisePanels() {
    const container = document.getElementById('exercise-panels-edit');
    if (!container || !editingWorkoutDate) return;

    const activeStrength = STRENGTH_TYPES.filter(t => editWorkoutTypes.includes(t));

    if (activeStrength.length === 0) {
        container.innerHTML = '';
        return;
    }

    let html = '';
    activeStrength.forEach(type => {
        const exercises = getExercises(editingWorkoutDate, type);
        html += buildExercisePanelHTML(type, exercises, 'edit');
    });
    container.innerHTML = html;
    renderAllExerciseHistories('edit');
}

function getExerciseDate(context) {
    return context === 'edit' ? editingWorkoutDate : getToday();
}

function addExercise(context, type) {
    const dateStr = getExerciseDate(context);
    const data = getData();
    if (!data.exercises[dateStr]) data.exercises[dateStr] = {};
    if (!data.exercises[dateStr][type]) data.exercises[dateStr][type] = [];
    data.exercises[dateStr][type].push({ name: '', sets: '', reps: '' });
    saveData(data);

    if (context === 'edit') {
        renderEditExercisePanels();
    } else {
        renderExercisePanels();
    }

    // Focus the new name input
    const container = document.getElementById(context === 'edit' ? 'exercise-panels-edit' : 'exercise-panels-today');
    const panels = container.querySelectorAll(`.exercise-panel.${type}`);
    if (panels.length > 0) {
        const rows = panels[0].querySelectorAll('.exercise-entry');
        if (rows.length > 0) {
            const lastRow = rows[rows.length - 1];
            const nameInput = lastRow.querySelector('.exercise-entry-top input[type="text"]');
            if (nameInput) nameInput.focus();
        }
    }
}

function removeExercise(context, type, index) {
    const dateStr = getExerciseDate(context);
    const exercises = getExercises(dateStr, type);
    exercises.splice(index, 1);
    saveExercises(dateStr, type, exercises);

    if (context === 'edit') {
        renderEditExercisePanels();
    } else {
        renderExercisePanels();
    }
}

function updateExercise(context, type, index, field, value) {
    const dateStr = getExerciseDate(context);
    const exercises = getExercises(dateStr, type);
    if (!exercises[index]) return;

    if (field === 'name') {
        exercises[index].name = value;
    } else if (field === 'sets') {
        exercises[index].sets = parseInt(value) || '';
    } else if (field === 'reps') {
        exercises[index].reps = parseInt(value) || '';
    } else if (field === 'kg') {
        exercises[index].kg = parseFloat(value) || '';
    }

    saveExercises(dateStr, type, exercises);
}

// Init
function checkNewDay() {
    const data = getData();
    if (data.supplements.date !== getToday()) {
        const last = new Date(data.supplements.date);
        const diff = Math.floor((new Date(getToday()) - last) / 86400000);
        if (diff > 1 || data.supplements.lastCompleted !== data.supplements.date) {
            data.supplements.streak = 0;
        }
        data.supplements.date = getToday();
        data.supplements.checked = {};
        saveData(data);
    }
}

const QUOTES = [
    ["The only person you are destined to become is the person you decide to be.", "Ralph Waldo Emerson"],
    ["Discipline is choosing between what you want now and what you want most.", "Abraham Lincoln"],
    ["The pain you feel today will be the strength you feel tomorrow.", "Arnold Schwarzenegger"],
    ["We are what we repeatedly do. Excellence is not an act, but a habit.", "Aristotle"],
    ["The body achieves what the mind believes.", "Napoleon Hill"],
    ["No man has the right to be an amateur in the matter of physical training.", "Socrates"],
    ["The resistance that you fight physically in the gym and the resistance that you fight in life can only build a strong character.", "Arnold Schwarzenegger"],
    ["Take care of your body. It's the only place you have to live.", "Jim Rohn"],
    ["Today I will do what others won't, so tomorrow I can accomplish what others can't.", "Jerry Rice"],
    ["Success isn't always about greatness. It's about consistency.", "Dwayne Johnson"],
    ["The last three or four reps is what makes the muscle grow.", "Arnold Schwarzenegger"],
    ["Your health is an investment, not an expense.", "Unknown"],
    ["The hard days are what make you stronger.", "Aly Raisman"],
    ["If something stands between you and your success, move it. Never be denied.", "Dwayne Johnson"],
    ["Strength does not come from the physical capacity. It comes from an indomitable will.", "Mahatma Gandhi"],
    ["The clock is ticking. Are you becoming the person you want to be?", "Greg Plitt"],
    ["You don't have to be extreme, just consistent.", "Unknown"],
    ["The iron never lies to you. Two hundred pounds is always two hundred pounds.", "Henry Rollins"],
    ["Once you learn to quit, it becomes a habit.", "Vince Lombardi"],
    ["What hurts today makes you stronger tomorrow.", "Jay Cutler"],
    ["The only bad workout is the one that didn't happen.", "Unknown"],
    ["Motivation is what gets you started. Habit is what keeps you going.", "Jim Ryun"],
    ["The difference between who you are and who you want to be is what you do.", "Unknown"],
    ["Don't count the days. Make the days count.", "Muhammad Ali"],
    ["The successful warrior is the average man, with laser-like focus.", "Bruce Lee"],
    ["You miss 100% of the shots you don't take.", "Wayne Gretzky"],
    ["Hard work beats talent when talent doesn't work hard.", "Tim Notke"],
    ["The mind is the limit. As long as the mind can envision it, you can achieve it.", "Arnold Schwarzenegger"],
    ["It's not about having time. It's about making time.", "Unknown"],
    ["The best time to plant a tree was 20 years ago. The second best time is now.", "Chinese Proverb"],
    ["Champions aren't made in gyms. Champions are made from something deep inside them.", "Muhammad Ali"],
    ["The day you stop making excuses is the day you start making progress.", "Greg Plitt"],
    ["You gotta want it so bad that it becomes a part of you.", "Greg Plitt"],
    ["To be the best, you must be willing to do what others won't.", "Greg Plitt"],
    ["The mind always fails first, not the body. The secret is to make your mind work for you, not against you.", "Greg Plitt"],
    ["Wake up and make a conscious decision every day to be better than you were yesterday.", "Greg Plitt"],
    ["If tomorrow wasn't promised, what would you give for today?", "Greg Plitt"],
    ["The real workout starts when you want to stop.", "Greg Plitt"],
    ["You are either getting better or you are getting worse. You never stay the same.", "Greg Plitt"],
    ["When you want to succeed as bad as you want to breathe, then you'll be successful.", "Eric Thomas"],
    ["Don't cry to quit. Cry to keep going.", "Eric Thomas"],
    ["The difference between those who succeed and those who fail isn't what they have â€” it's what they do with what they have.", "Eric Thomas"],
    ["Everybody wants to be a beast until it's time to do what beasts do.", "Eric Thomas"],
    ["You can't cheat the grind. It knows how much you've invested. It won't give you anything you haven't worked for.", "Eric Thomas"],
    ["When you find your why, you find a way to make it happen.", "Eric Thomas"],
    ["Pain is temporary. It may last for a minute, an hour, a day, or even a year, but eventually it will subside.", "Eric Thomas"],
    ["Fall in love with the process, and the results will come.", "Eric Thomas"],
    ["Information changes situations.", "Eric Thomas"],
    ["Winners focus on winning. Losers focus on winners.", "Eric Thomas"],
];

function getDailyQuote() {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
    const quote = QUOTES[dayOfYear % QUOTES.length];
    document.getElementById('daily-quote').innerHTML =
        `"${quote[0]}"<span class="quote-author">â€” ${quote[1]}</span>`;

    const todayStr = today.toISOString().slice(0, 10);
    const lastAck = localStorage.getItem('quoteAcknowledged');
    if (lastAck !== todayStr) {
        document.getElementById('quote-modal-text').textContent = `"${quote[0]}"`;
        document.getElementById('quote-modal-author').textContent = `â€” ${quote[1]}`;
        document.getElementById('quote-modal').classList.add('visible');
    }
}

document.getElementById('quote-modal-btn').addEventListener('click', function() {
    const overlay = document.getElementById('quote-modal');
    overlay.style.animation = 'none';
    overlay.style.transition = 'opacity 0.3s ease';
    overlay.style.opacity = '0';
    setTimeout(() => {
        overlay.classList.remove('visible');
        overlay.style.cssText = '';
    }, 300);
    localStorage.setItem('quoteAcknowledged', new Date().toISOString().slice(0, 10));
});

function init() {
    checkNewDay();
    document.getElementById('current-date').textContent = formatDate(getToday());
    getDailyQuote();

    renderSupplements();
    renderCycleStatus();
    restoreCheckboxState();

    const data = getData();
    document.getElementById('stat-streak').textContent = data.supplements.streak || 0;

    updateCycles();
    updateSupplements();
    updateWeightDisplay();
    updateWorkoutDisplay();
}

// Export
function exportData() {
    const data = getData();
    data.exportDate = new Date().toISOString();
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `health-tracker-${getToday()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Import
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);

            // Validate it looks like our data
            if (!imported.supplements && !imported.weight && !imported.workouts) {
                alert('Invalid file format. This doesn\'t look like a Health Tracker backup.');
                return;
            }

            // Confirm before overwriting
            const weightCount = imported.weight ? Object.keys(imported.weight).length : 0;
            const workoutCount = imported.workouts ? Object.keys(imported.workouts).length : 0;
            const stepsCount = imported.steps ? Object.keys(imported.steps).length : 0;
            const exerciseCount = imported.exercises ? Object.keys(imported.exercises).length : 0;

            const msg = `Import backup?\n\nThis will replace your current data with:\n` +
                `â€¢ ${weightCount} weight entries\n` +
                `â€¢ ${workoutCount} workout entries\n` +
                `â€¢ ${stepsCount} steps entries\n` +
                `â€¢ ${exerciseCount} exercise entries\n` +
                `â€¢ Supplement streak: ${imported.supplements?.streak || 0} days\n\n` +
                `This cannot be undone.`;

            if (!confirm(msg)) return;

            // Merge with defaults to ensure all fields exist
            const data = getData();
            if (imported.supplements) data.supplements = { ...data.supplements, ...imported.supplements };
            if (imported.cycles) data.cycles = { ...data.cycles, ...imported.cycles };
            if (imported.weight) data.weight = imported.weight;
            if (imported.workouts) data.workouts = imported.workouts;
            if (imported.steps) data.steps = imported.steps;
            if (imported.exercises) data.exercises = imported.exercises;
            if (imported.supplementDefs) data.supplementDefs = imported.supplementDefs;

            saveData(data);

            // Refresh UI
            init();

            alert('Data imported successfully!');
        } catch (err) {
            alert('Error reading file. Make sure it\'s a valid JSON backup.');
            console.error(err);
        }
    };
    reader.readAsText(file);

    // Reset file input so same file can be selected again
    event.target.value = '';
}

// Clipboard Sync
function showToast(message, isError) {
    const toast = document.getElementById('toast');
    if (showToast._timer) clearTimeout(showToast._timer);
    toast.textContent = message;
    toast.className = 'toast' + (isError ? ' error' : '');
    // Force reflow to restart transition
    void toast.offsetWidth;
    toast.classList.add('visible');
    showToast._timer = setTimeout(() => {
        toast.classList.remove('visible');
    }, 2500);
}

function encodeData(data) {
    return 'HT:' + btoa(unescape(encodeURIComponent(JSON.stringify(data))));
}

function decodeData(str) {
    str = str.trim();
    if (!str.startsWith('HT:')) throw new Error('Invalid sync string â€” must start with HT:');
    const b64 = str.slice(3);
    return JSON.parse(decodeURIComponent(escape(atob(b64))));
}

function copyData() {
    const text = encodeData(getData());
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard!');
        }).catch(() => {
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly', '');
    ta.style.cssText = 'position:fixed;left:-9999px;top:-9999px;opacity:0';
    document.body.appendChild(ta);
    ta.setSelectionRange(0, text.length);
    try {
        document.execCommand('copy');
        showToast('Copied to clipboard!');
    } catch (e) {
        showToast('Copy failed â€” select manually', true);
    }
    document.body.removeChild(ta);
}

function openPasteModal() {
    const modal = document.getElementById('paste-modal');
    const input = document.getElementById('paste-input');
    input.value = '';
    modal.classList.add('visible');
    setTimeout(() => input.focus(), 100);
}

function closePasteModal() {
    document.getElementById('paste-modal').classList.remove('visible');
}

function handlePasteOverlayClick(event) {
    if (event.target === event.currentTarget) closePasteModal();
}

function loadPastedData() {
    const input = document.getElementById('paste-input');
    const raw = input.value.trim();
    if (!raw) {
        showToast('Paste a sync string first', true);
        return;
    }
    try {
        const imported = decodeData(raw);
        if (!imported.supplements && !imported.weight && !imported.workouts) {
            showToast('Invalid data format', true);
            return;
        }
        const weightCount = imported.weight ? Object.keys(imported.weight).length : 0;
        const workoutCount = imported.workouts ? Object.keys(imported.workouts).length : 0;
        const stepsCount = imported.steps ? Object.keys(imported.steps).length : 0;
        const exerciseCount = imported.exercises ? Object.keys(imported.exercises).length : 0;
        const msg = `Load synced data?\n\nThis will replace your current data with:\n` +
            `â€¢ ${weightCount} weight entries\n` +
            `â€¢ ${workoutCount} workout entries\n` +
            `â€¢ ${stepsCount} steps entries\n` +
            `â€¢ ${exerciseCount} exercise entries\n` +
            `â€¢ Supplement streak: ${imported.supplements?.streak || 0} days\n\n` +
            `This cannot be undone.`;
        if (!confirm(msg)) return;
        const data = getData();
        if (imported.supplements) data.supplements = { ...data.supplements, ...imported.supplements };
        if (imported.cycles) data.cycles = { ...data.cycles, ...imported.cycles };
        if (imported.weight) data.weight = imported.weight;
        if (imported.workouts) data.workouts = imported.workouts;
        if (imported.steps) data.steps = imported.steps;
        if (imported.exercises) data.exercises = imported.exercises;
        if (imported.supplementDefs) data.supplementDefs = imported.supplementDefs;
        saveData(data);
        closePasteModal();
        init();
        showToast('Data loaded successfully!');
    } catch (err) {
        showToast('Invalid sync string â€” check and try again', true);
        console.error(err);
    }
}

window.onload = init;
window.onresize = () => drawCharts();
</script>

</body>
</html>
